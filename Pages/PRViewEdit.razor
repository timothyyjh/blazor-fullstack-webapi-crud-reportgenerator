@page "/ViewPR/{id:int}"
@inject IePRService ePRService
@inject NavigationManager NavigationManager

<h3>Edit Purchase Order [Code: @newPurchaseOrderModel.Code]</h3>

<body>
    <EditForm Model="newPurchaseOrderModel" OnValidSubmit="HandleSave">
        <div>
            <DataAnnotationsValidator />
            <ValidationSummary />
            <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Code:</th>
                        <th>Date:</th>
                        <th>Name:</th>
                        <th>Doc No:</th>
                        <th>Supplier:</th>
                        <th>Address Line</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <label for="code"></label>
                            <input id="codeinput" readonly class="form-control" @bind-value="@newPurchaseOrderModel.Code"/>
                            @*<InputNumber id="codeinput" class="form-control" @bind-Value="newPurchaseOrderModel.Code" />*@
                        </td>
                        <td>
                            <label for="date"></label>
                            <InputDate id="dateinput" class="form-control" @bind-Value="newPurchaseOrderModel.Date" />
                        </td>
                        <td>
                            <label for="name" />
                            <InputText id="nameinput" class="form-control" @bind-Value="newPurchaseOrderModel.Name" />
                        </td>
                        <td>
                            <label for="docno"></label>
                            <InputNumber id="numberinput" class="form-control" @bind-Value="newPurchaseOrderModel.DocNumber" />
                        </td>
                        <td>
                            <label for="supplier"></label>
                            <InputSelectNumber id="supplierselect" @bind-Value="newPurchaseOrderModel.Supplier" class="form-control">
                                @foreach (var supplier in ePRService.Suppliers)
                                {
                                    <option value="@supplier.Code">@supplier.Code</option>
                                }
                            </InputSelectNumber>
                        </td>
                        <td>
                            <label for="address"></label>
                            <InputText id="addressinput" placeholder="Address Line 1" @bind-Value="newPurchaseOrderModel.AddressLine1" class="form-control" />
                            <InputText id="addressinput" placeholder="Address Line 2" @bind-Value="newPurchaseOrderModel.AddressLine2" class="form-control" />
                            <InputText id="addressinput" placeholder="Address Line 3" @bind-Value="newPurchaseOrderModel.AddressLine3" class="form-control" />
                            <InputText id="addressinput" placeholder="Address Line 4" @bind-Value="newPurchaseOrderModel.AddressLine4" class="form-control" />
                        </td>
                    </tr>
                </tbody>
            </table>
            <br />

        </div>
            
        
        <button class="btn btn-primary mb-3 rounded-pill" type="button" @onclick="(() => HandleItemReferenceAdd())"><i class="oi oi-plus"></i></button>
        <table class="table table-borderless table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>POCode</th>
                    <th>Code</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in ePRService.ItemLists.Where(x => x.POCode == Id))
                {
                <tr>
                    <td>@item.POCode</td>
                    <td>@item.Code</td>
                    <td>@item.Qty</td>
                    <td>@item.Price</td>
                    <td><button class="btn btn-danger rounded-pill" type="button" @onclick="() => DeleteItem(item.Id)"><i class="oi oi-minus"></i></button></td>
                </tr>
                }
            </tbody>
        </table>
        <div>
            <button class="btn btn-success mb-3" type="submit">Save</button>
            <button class="btn btn-warning mb-3" @onclick="Cancel">Cancel</button>
        </div>
    </EditForm>
</body>


@code {
    [Parameter]
    public int? Id { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        newPurchaseOrderModel = await ePRService.GetPurchaseOrderModelId((int)Id);
    }

    ItemListModel newItemListModel = new ItemListModel();

    PurchaseOrderModel newPurchaseOrderModel = new PurchaseOrderModel();

    SupplierModel newSupplier = new SupplierModel();

    ItemModel newItem = new ItemModel();

    protected override async Task OnInitializedAsync()
    {
        await ePRService.GetSupplier();
        await ePRService.GetPurchaseOrderItemList();
    }

    private void HandleItemReferenceAdd()
    {
        NavigationManager.NavigateTo($"/ItemList/{Id}");
    }

    private void DeleteItem(int id)
    {
        ePRService.DeletePurchaseOrderItemList(id);
        NavigationManager.NavigateTo($"/ViewPR/{Id}", true);
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/purchaseorder");
    }

    async Task HandleSave()
    {
        await ePRService.UpdatePurchaseOrderModel(newPurchaseOrderModel);
        NavigationManager.NavigateTo("/purchaseorder", true);
    }
}
